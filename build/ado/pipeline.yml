name: "0.0$(Rev:.r)"

parameters:
  - name: pre_release
    displayName: Create a pre-release from a feature branch
    type: boolean
    default: false

  - name: generate_docs
    type: boolean
    default: true
    displayName: Generate Documentation

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - "src/*"

pr:
  branches:
    include:
      - main
  paths:
    include:
      - src/*

variables:
  - template: variables.yml

stages:
  - stage: prelim
    displayName: Preliminaries

    jobs:
      - job: version_number
        displayName: Set Build Number
        pool:
          vmImage: $(pool_vm_image)

        steps:
          - template: templates/setup.yml
            parameters:
              EirctlVersion: $(EirctlVersion)

          # Update the build number
          - task: Bash@3
            displayName: Set Build Number
            inputs:
              targetType: inline
              script: |
                eirctl build:number

          - task: Bash@3
            displayName: Perform YAML linting
            inputs:
              targetType: inline
              script: |
                eirctl lint:yaml

          - task: Bash@3
            displayName: Perform Terraform format check
            inputs:
              targetType: inline
              script: |
                eirctl lint:terraform:format
            env:
              TF_FILE_LOCATION: "/eirctl/src"

  - stage: docs
    displayName: Documentation
    condition: and(succeeded(), eq(${{ parameters.generate_docs }}, true))
    dependsOn:
      - prelim

    jobs:
      - job: generate_docs
        displayName: Generate Documentation
        pool:
          vmImage: $(pool_vm_image)

        steps:
          - template: templates/setup.yml
            parameters:
              EirctlVersion: $(EirctlVersion)

          - task: Bash@3
            displayName: Generate Documentation
            inputs:
              targetType: inline
              script: |
                eirctl docs
            env:
              BUILDNUMBER: $(Build.BuildNumber)

          # Upload the documentation as a pipeline artifact
          - task: PublishBuildArtifacts@1
            displayName: Publish Documentation
            inputs:
              pathToPublish: $(Build.SourcesDirectory)/outputs/docs
              artifactName: docs

  - stage: build
    displayName: Build Module
    dependsOn:
      - prelim

    jobs:
      - job: unit_tests
        displayName: Run Unit Tests
        pool:
          vmImage: $(pool_vm_image)

        steps:
          - template: templates/setup.yml
            parameters:
              EirctlVersion: $(EirctlVersion)

          - task: Bash@3
            displayName: Run Terraform Tests
            inputs:
              targetType: inline
              script: |
                eirctl tests
            env:
              TF_FILE_LOCATION: "/eirctl/src"

      - job: create_package
        displayName: Create Package
        dependsOn:
          - unit_tests
        pool:
          vmImage: $(pool_vm_image)

        steps:
          - template: templates/setup.yml
            parameters:
              EirctlVersion: $(EirctlVersion)

          - task: Bash@3
            displayName: Package Module
            inputs:
              targetType: inline
              script: |
                eirctl build
            env:
              BUILDNUMBER: $(Build.BuildNumber)

          # Upload the zip file as a pipeline artifact
          - task: PublishBuildArtifacts@1
            displayName: Publish Package
            inputs:
              pathToPublish: $(Build.SourcesDirectory)/outputs/stacks-foundation-azure-$(Build.BuildNumber).zip
              artifactName: package

          - task: PublishBuildArtifacts@1
            displayName: Publish README file
            inputs:
              pathToPublish: $(Build.SourcesDirectory)/outputs/module/README.md
              artifactName: readme

  - stage: release
    dependsOn:
      - build
    condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(${{ parameters.pre_release }}, true)))

    variables:
      - group: github-creds

    jobs:
      - job: CreateGHRelease
        pool:
          vmImage: $(pool_vm_image)

        steps:
          # Download the necessary artifacts from the previous stage
          # - documentation
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: "docs"
              patterns: "**/*.pdf"
              path: $(Build.SourcesDirectory)/outputs/assets

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: "package"
              path: $(Build.SourcesDirectory)/outputs/assets

          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: "readme"
              path: $(Build.SourcesDirectory)/outputs/assets

          # Install Eirctl for the build to run
          - template: templates/setup.yml
            parameters:
              EirctlVersion: $(EirctlVersion)

          # Run the tasks to build the application
          - task: Bash@3
            displayName: Release
            inputs:
              targetType: inline
              script: |
                eirctl release
            env:
              STAGE: "release"
              PUBLISH_RELEASE: "true"
              GITHUB_TOKEN: "$(GITHUB_TOKEN)"
              OWNER: $(RepoOwner)
              REPOSITORY: $(RepoName)
              BUILD_BUILDNUMBER: $(BUILD_BUILDNUMBER)
              COMMIT_ID: $(Build.SourceVersion)
              ARTIFACTS_DIR: /eirctl/outputs/assets
              ${{ if ne(variables['Build.SourceBranch'], 'refs/heads/main') }}:
                PRERELEASE: "true"
