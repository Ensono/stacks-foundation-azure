== Unit Testing

The repository includes comprehensive unit tests using Terraform's native test framework (available in Terraform 1.6.0+).

=== Running Tests

[source,bash]
----
# Run all tests
cd src
terraform test

# Run specific test file
terraform test tests/basic_naming.tftest.hcl

# Run with verbose output
terraform test -verbose
----

=== Test Structure

Tests are located in `src/tests/` and cover:

[cols="1,3"]
|===
|Test File |Coverage

|`basic_naming.tftest.hcl`
|Basic naming functionality, outputs, and seed generation

|`multi_project.tftest.hcl`
|Multiple projects in a single deployment

|`short_name_length.tftest.hcl`
|Short name length configuration (default, custom, minimum)

|`region_filtering.tftest.hcl`
|Region filtering by recommendation and geography

|`outputs_validation.tftest.hcl`
|Output structure and availability

|`extended_naming.tftest.hcl`
|Extended resource naming (Fabric, AI services, Front Door, etc.)

|`env_file_generation.tftest.hcl`
|Environment file generation (partial - see limitations below)

|`workspace_naming.tftest.hcl`
|Workspace-based naming differentiation
|===

=== Test Implementation Details

All tests use `command = apply` to create actual resources during testing. This approach:

* **Allows validation of computed values** - Resource outputs, random strings, and module-generated values are only available after apply
* **Ensures real-world behavior** - Tests validate that resources can actually be created
* **Auto-cleanup** - Terraform test framework automatically destroys resources after each test run

[IMPORTANT]
====
Tests do **not** create actual Azure resources. The module only generates naming conventions and configuration data using:

* `random_string` resources (for unique seeds)
* `time_static` resources (for state timestamps)  
* `local_file` resources (for environment files, when enabled)
* Data sources from `azapi_client_config` (for Azure tenant/subscription info)

No billable Azure resources are created during testing.
====

=== Test Limitations

Some tests have limitations due to Terraform test framework constraints:

**Environment File Generation Tests**

The `env_file_generation.tftest.hcl` tests have `generate_env_files = false` because:

* The `templatefile()` function requires template files to be part of the configuration source code
* When tests run, `path.module` resolves to the test execution context (`.`), not the module source directory
* Template files in `../templates/` are not accessible from the test context
* This is a Terraform limitation, not a module issue

**Workaround for env file testing:**

[source,bash]
----
# Test env file generation manually
cd src

terraform init
terraform apply -var="company_name=TestCo" \
  -var="location=uksouth" \
  -var='project=["webapp"]' \
  -var="stage_name=foundation" \
  -var="environment=dev" \
  -var="generate_env_files=true" \
  -var='outputs={"dev":{"test_key":"test_value"}}'

# Check generated files
ls -la outputs/terraform/
----

=== Expected Test Results

When running `terraform test`, you should see:

[source]
----
Success! 16 passed, 0 failed.
----

All tests should pass. If any tests fail, check:

1. Terraform version (must be 1.6.0+)
2. Azure CLI authentication (for `azapi_client_config` data source)
3. Network connectivity to Azure
4. Provider plugin versions

=== Test Coverage Matrix

Terraform's native test framework does not provide built-in code coverage reports. Use this matrix to manually track test coverage across module features:

[cols="2,1,1,3"]
|===
|Feature/Component |Tested |Test File |Notes

|**Core Naming**
|
|
|

|Basic resource naming
|✅
|`basic_naming.tftest.hcl`
|Validates names, extended_names, regions outputs

|Company name shortening
|✅
|`basic_naming.tftest.hcl`
|Tests `var.short_name_length` (default 4 chars)

|Random seed generation
|✅
|`basic_naming.tftest.hcl`
|Validates 4-character lowercase seed

|State timestamp
|✅
|`basic_naming.tftest.hcl`
|Verifies `time_static` resource output

|**Project Configuration**
|
|
|

|Single project
|✅
|`basic_naming.tftest.hcl`
|Tests with one project in `var.project`

|Multiple projects
|✅
|`multi_project.tftest.hcl`
|Tests 3 projects simultaneously

|Project name validation
|⚠️
|_Manual testing required_
|No automated tests for invalid project names

|**Short Name Length**
|
|
|

|Default length (4 chars)
|✅
|`short_name_length.tftest.hcl`
|Uses default `var.short_name_length`

|Custom length (6 chars)
|✅
|`short_name_length.tftest.hcl`
|Tests custom short name length

|Minimum length (1 char)
|✅
|`short_name_length.tftest.hcl`
|Edge case: shortest possible name

|Maximum length
|❌
|_Not tested_
|Consider adding test for max length

|**Region Configuration**
|
|
|

|Default region (location)
|✅
|`basic_naming.tftest.hcl`
|Tests with `var.location = "uksouth"`

|Recommendation filter enabled
|✅
|`region_filtering.tftest.hcl`
|Tests `region_recommend_filter = true`

|Geography filter (Europe)
|✅
|`region_filtering.tftest.hcl`
|Tests `region_geography = "Europe"`

|No filters
|✅
|`region_filtering.tftest.hcl`
|Tests with all regions available

|Custom AVM region version
|⚠️
|_Manual testing required_
|No automated test for `var.avm_region_version`

|**Extended Naming**
|
|
|

|Fabric resources
|✅
|`extended_naming.tftest.hcl`
|Tests fabric_capacity, workspace, lakehouse

|AI services
|✅
|`extended_naming.tftest.hcl`
|Tests ai_services, ai_foundry, ai_foundry_project

|Front Door resources
|✅
|`extended_naming.tftest.hcl`
|Tests firewall_policy, endpoint, security_policy

|Managed Identity
|✅
|`extended_naming.tftest.hcl`
|Tests managed_identity naming

|Key Vault v2
|✅
|`extended_naming.tftest.hcl`
|Tests key_vault_v2 naming

|Private DNS VNet Link
|✅
|`extended_naming.tftest.hcl`
|Tests private_dns_zone_virtual_network_link

|Custom prefix override
|✅
|`extended_naming.tftest.hcl`
|Tests `var.custom_prefix` for extended resources

|**Outputs**
|
|
|

|names output
|✅
|`outputs_validation.tftest.hcl`
|Validates standard naming output structure

|extended_names output
|✅
|`outputs_validation.tftest.hcl`
|Validates extended naming output

|regions output
|✅
|`outputs_validation.tftest.hcl`
|Validates regions data output

|seed output
|✅
|`outputs_validation.tftest.hcl`
|Validates random seed output

|state_time output
|✅
|`outputs_validation.tftest.hcl`
|Validates state timestamp output

|computed_outputs
|✅
|`outputs_validation.tftest.hcl`
|Validates merged outputs structure

|**Environment Files**
|
|
|

|Disabled by default
|✅
|`env_file_generation.tftest.hcl`
|Tests `generate_env_files = false` (default)

|Bash template generation
|⚠️
|_Limited coverage_
|Templates not accessible from test context

|PowerShell template generation
|⚠️
|_Limited coverage_
|Templates not accessible from test context

|Terraform vars template
|⚠️
|_Limited coverage_
|Templates not accessible from test context

|Output encoding (JSON)
|✅
|`env_file_generation.tftest.hcl`
|Tests list/map JSON encoding

|Hyphen to underscore conversion
|✅
|`env_file_generation.tftest.hcl`
|Tests key normalization in outputs

|**Workspace Integration**
|
|
|

|Workspace in naming suffix
|✅
|`workspace_naming.tftest.hcl`
|Tests workspace name in generated names

|Different workspaces
|✅
|`workspace_naming.tftest.hcl`
|Validates workspace differentiation

|Default workspace
|⚠️
|_Manual testing required_
|No test for "default" workspace behavior

|**Stage Name**
|
|
|

|Foundation stage
|✅
|Multiple test files
|Most tests use `stage_name = "foundation"`

|Networking stage
|✅
|`env_file_generation.tftest.hcl`
|Tests `stage_name = "networking"`

|Custom stage names
|⚠️
|_Manual testing required_
|No comprehensive test coverage

|**Edge Cases & Validation**
|
|
|

|Empty project list
|❌
|_Not tested_
|Should test `var.project = []`

|Invalid location
|❌
|_Not tested_
|Should test non-existent Azure region

|Special characters in inputs
|❌
|_Not tested_
|Should test input sanitization

|Very long company names
|❌
|_Not tested_
|Should test truncation behavior

|Outputs with null environment
|❌
|_Not tested_
|Should test missing environment in outputs JSON

|===

**Legend:**

* ✅ = Fully tested with automated tests
* ⚠️ = Partially tested or requires manual testing
* ❌ = Not tested (gap in coverage)

**Coverage Summary:**

* **Strong Coverage**: Core naming, project configuration, short names, regions, extended naming, outputs
* **Adequate Coverage**: Workspace integration, basic env file generation
* **Coverage Gaps**: Edge cases, input validation, template file generation, error handling

**Recommendations for Improving Coverage:**

1. Add validation tests for invalid inputs (empty projects, bad regions, etc.)
2. Add edge case tests for boundary conditions
3. Consider integration tests for env file generation (requires manual execution)
4. Add tests for all supported `stage_name` values
5. Test workspace edge cases (default workspace, special characters)
6. Add negative tests using `expect_failures` for validation blocks

[TIP]
====
When adding new features, update this coverage matrix and create corresponding test files to maintain test coverage.
====
