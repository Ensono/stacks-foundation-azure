# Stacks Foundation Azure - Project Context

## Project Overview

**Project Name:** Stacks Foundation Azure  
**Organization:** Ensono  
**Type:** Terraform Foundation Module  
**Purpose:** Foundational Terraform module providing standardized naming conventions and regional configurations for Azure resources across Ensono Stacks infrastructure deployments.

## What This Project Does

This is a **foundational infrastructure module** that:

1. **Standardizes Azure Resource Naming** - Generates consistent, unique names for Azure resources following organizational conventions
2. **Manages Azure Region Selection** - Provides intelligent region selection with geography and recommendation filtering
3. **Creates Unique Identifiers** - Generates random seeds to prevent resource name collisions
4. **Supports Multi-Project Deployments** - Handles multiple projects/workloads within a single deployment
5. **Generates Environment Files** - Creates Bash, PowerShell, and Terraform variable files for environment configuration
6. **Extends Azure Naming** - Adds custom naming patterns for Azure resources not covered by the base Azure Naming module

## Key Components

### Core Terraform Files (in `src/`)

- **`naming.tf`** - Integrates Azure Naming module, creates naming conventions per project
- **`regions.tf`** - Integrates Azure Regions utility module for region metadata
- **`random_string.tf`** - Generates 4-character random seed for unique naming
- **`variables.tf`** - Input variable definitions (company, project, location, environment, etc.)
- **`outputs.tf`** - Exposes names, extended_names, regions, computed_outputs, state_time, seed
- **`locals.tf`** - Complex local transformations including:
  - Template file definitions
  - Output encoding logic
  - Extended naming map for unsupported Azure resources (Fabric, Front Door, AI services, etc.)
  - Naming map simplification
- **`envvar_files.tf`** - Generates environment variable files from templates
- **`time_static.tf`** - Captures static time for state tracking
- **`providers.tf`** - Currently empty

### Build System

**Build Tool:** `eirctl` (Ensono Infrastructure CLI)

**Build Pipeline (`eirctl.yaml`):**
```
build:
  1. build:clean       - Clean outputs folder
  2. terraform:docs    - Generate Terraform docs using terraform-docs
  3. docs:docbook      - Convert AsciiDoc to DocBook XML
  4. docs:markdown     - Convert DocBook to GitHub Markdown
  5. build:copy        - Copy src/ to outputs/module/
  6. build:package     - Create zip package
```

**Container Contexts:**
- `powershell` - ensono/eir-foundation-powershell
- `infra` - ensono/eir-infrastructure (for terraform-docs)
- `asciidoc` - ensono/eir-asciidoctor (for documentation conversion)

### Templates (`templates/`)

1. **`envvars.bash.tpl`** - Bash environment variable exports
2. **`envvars.ps1.tpl`** - PowerShell environment variable assignments
3. **`inputs.auto.tfvars.tpl`** - Terraform auto-variables file

These templates are used to generate environment-specific configuration files for downstream consumers.

### Documentation (`docs/`)

- **`docs/readme/index.adoc`** - Main documentation entry (includes tfdocs.adoc)
- **`docs/readme/tfdocs.adoc`** - Auto-generated Terraform documentation (terraform-docs output)
- **`docs/README.adoc`** - Comprehensive manual documentation created for the project

Documentation is written in **AsciiDoc** format and converted to Markdown via DocBook for GitHub compatibility.

## Naming Convention Structure

```
<resource-type-prefix>-<company-short>-<project-short>-<region-code>-<workspace>-<random-seed>
```

**Example:** `rg-enso-netw-uks-dev-abcd`

- `rg` = Resource Group prefix
- `enso` = Company name (first 4 chars of `var.company_name`)
- `netw` = Project name (first 4 chars of project)
- `uks` = UK South region code
- `dev` = Terraform workspace (environment)
- `abcd` = Random 4-char seed

**Short name length** is configurable via `var.short_name_length` (default: 4)

## Extended Naming for Unsupported Resources

The module extends the base Azure Naming module to support additional Azure resources:

- **Microsoft Fabric:** `fabric_capacity`, `fabric_workspace`, `fabric_lakehouse`
- **Front Door:** `frontdoor_firewall_policy`, `frontdoor_endpoint`, `frontdoor_security_policy`
- **AI Services:** `ai_services`, `ai_foundry`, `ai_foundry_project`
- **Identity:** `managed_identity`
- **Networking:** `private_dns_zone_virtual_network_link`
- **Key Vault v2:** `key_vault_v2`

These are generated by taking existing resource names and replacing prefixes with custom abbreviations.

## Key Variables

### Required
- `company_name` - Full company name (auto-shortened to first N chars)
- `location` - Azure region (e.g., "uksouth")
- `project` - Set of project names (e.g., ["networking", "webapp"])
- `stage_name` - Terraform stage being deployed
- `environment` - Environment name (e.g., "dev", "prod")

### Optional
- `short_name_length` - Length for short names (default: 4)
- `enable_avm_telemetry` - Azure Verified Modules telemetry (default: false)
- `region_recommend_filter` - Use only recommended regions (default: true)
- `region_geography` - Filter by geography (default: null)
- `generate_env_files` - Generate environment variable files (default: false)
- `output_path` - Path for generated files (default: "../../outputs")
- `outputs` - JSON string of outputs to encode into env files

## Module Dependencies

```hcl
module "azure_naming" {
  source  = "Azure/naming/azurerm"
  version = "0.4.2"  # NOTE: Hardcoded in naming.tf
}

module "azure_regions" {
  source  = "Azure/avm-utl-regions/azurerm"
  version = "0.5.0"  # NOTE: Hardcoded in regions.tf
}
```

## Output Structure

### `names`
Complete Azure Naming module output for each project with `name` and `name_unique` for all Azure resource types.

### `extended_names`
Custom naming for Fabric, Front Door, AI services, etc. - resources not in base naming module.

### `regions`
Full region metadata from Azure Regions module including geo codes, paired regions, availability zones.

### `computed_outputs`
Processed outputs from `var.outputs` JSON string, used for environment file generation.

### `state_time`
Static timestamp from `time_static` resource.

### `seed`
The random 4-character seed used in all naming.

## Build Process

**Command:** `eirctl build`

**Steps:**
1. Cleans `outputs/` directory
2. Runs `terraform-docs` to generate API documentation from Terraform code
3. Converts AsciiDoc documentation to DocBook XML
4. Converts DocBook XML to GitHub-flavored Markdown
5. Copies all `src/*` files to `outputs/module/`
6. Packages `outputs/module/` into `outputs/stacks-foundation-azure.zip`

**Output:** Distributable Terraform module package with documentation

## File Locations

### Source Code
- `src/` - All Terraform source files

### Build Artifacts (Ignored by Git)
- `outputs/` - Generated documentation and packaged module
- `outputs/module/` - Assembled module ready for distribution
- `outputs/tmp/` - Temporary DocBook XML
- `outputs/stacks-foundation-azure.zip` - Final package

### Configuration
- `.terraform-docs.yml` - terraform-docs configuration (AsciiDoc output)
- `eirctl.yaml` - Build pipeline definition
- `build/eirctl/tasks.yaml` - Task definitions
- `build/eirctl/contexts.yaml` - Container context definitions

## Development Workflow

### Making Changes
1. Edit Terraform files in `src/`
2. Update documentation in `docs/readme/` (if needed)
3. Run `eirctl build` to regenerate documentation and package
4. Test the module by consuming it from another Terraform project

### Documentation Updates
- **Auto-generated:** `docs/readme/tfdocs.adoc` (from terraform-docs)
- **Manual:** `docs/README.adoc` (comprehensive guide)
- **Index:** `docs/readme/index.adoc` (includes tfdocs)

### Adding New Extended Resource Types
1. Add new resource type to `extended_naming_map` in `src/locals.tf`
2. Base it on an existing resource name (usually `resource_group` or `storage_account`)
3. Use regex to replace prefix with new abbreviation
4. Document in `docs/README.adoc`

## Important Notes

### Workspace-Aware Naming
The module uses `terraform.workspace` in naming, so the same code generates different names per environment:
- `terraform workspace select dev` → `rg-enso-proj-uks-dev-abcd`
- `terraform workspace select prod` → `rg-enso-proj-uks-prod-abcd`

### Output Encoding Logic
The `encoded_outputs` local in `locals.tf` performs smart encoding:
- Detects arrays and objects → uses `jsonencode()`
- Simple values → uses `tostring()`
- Replaces hyphens with underscores in keys for environment variable compatibility

### Template File Generation
When `var.generate_env_files = true`, the module generates:
- `{environment}-networking-envvars.bash`
- `{environment}-networking-envvars.ps1`
- `{environment}-networking-inputs.auto.tfvars`

These are saved to `{output_path}/terraform/` directory.

### Version Pinning
- Azure Naming module version is **hardcoded** at 0.4.2
- Azure Regions module version is **hardcoded** at 0.5.0
- Consider making these configurable via variables if needed

## Common Tasks

### Add a New Variable
1. Add to `src/variables.tf`
2. Update `docs/readme/` if user-facing
3. Run `eirctl build` to regenerate docs

### Add Extended Resource Type
1. Edit `extended_naming_map` in `src/locals.tf`
2. Follow existing pattern (use regex replace on base resource)
3. Test the output

### Change Naming Structure
1. Modify `suffix` list in `src/naming.tf`
2. Be aware this affects ALL resources
3. May cause resource recreation in existing environments

### Update Documentation
1. Edit `docs/README.adoc` or relevant files
2. Run `eirctl build` to convert to Markdown
3. Check `outputs/module/README.md`

## Technology Stack

- **Infrastructure as Code:** Terraform
- **Documentation:** AsciiDoc → DocBook → Markdown
- **Build Orchestration:** eirctl (Ensono Infrastructure CLI)
- **Containers:** Docker (via eirctl contexts)
- **Tools:**
  - terraform-docs (API documentation)
  - asciidoctor (DocBook conversion)
  - pandoc (Markdown conversion)
  - PowerShell (build scripts)

## License

MIT License - Copyright (c) 2025 Ensono

## Project Status

**Active Development** - This is a foundational module used across Ensono Stacks infrastructure.

## When Working on This Project

1. **Understand the impact** - Changes affect all downstream infrastructure
2. **Test thoroughly** - Use test workspaces and projects
3. **Document changes** - Update both auto and manual docs
4. **Rebuild package** - Always run `eirctl build` before distributing
5. **Version carefully** - Consider semantic versioning for releases
6. **Check name lengths** - Azure has strict limits (e.g., Storage Account: 3-24 chars)

## Key Architectural Decisions

1. **Dual naming outputs** - Both `names` (standard) and `extended_names` (custom) to support all Azure resources
2. **Workspace integration** - Environment differentiation via Terraform workspaces
3. **Random seed** - 4-character random string ensures global uniqueness
4. **Template-based env files** - Supports multiple shell/platform environments
5. **AsciiDoc documentation** - Professional documentation with conversion to Markdown
6. **Container-based builds** - Consistent build environment via eirctl containers
7. **Short name truncation** - Configurable to handle Azure resource name length limits
